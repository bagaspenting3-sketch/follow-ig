case ENET_EVENT_TYPE_CONNECT:
{
    bool quit = false;
    
    // Kirim packet hello/init terlebih dahulu
    send_gt_packet(peer, 0);  // Hello packet
    
    // Tunggu sebentar
    std::this_thread::sleep_for(std::chrono::milliseconds(100));
    
    // Kirim packet untuk memulai cache download
    send_gt_packet(peer, 1);  // Cache info packet
    
    // Kirim welcome message
    const char* welcome_msg = "`2Connected to `wGeometry Private Server!``";
    send_gt_packet(peer, 2, welcome_msg, strlen(welcome_msg));
    
    // Set player data
    peer->data = new Player;
    
    char clientConnection[16];
    string clientIP;
    enet_address_get_host_ip(&peer->address, clientConnection, 16);
    clientIP = clientConnection;
    pInfo(peer)->id = peer->connectID;
    pInfo(peer)->ip = clientIP;
    
    // Ban check
    vector<pair<string, long long int>>::iterator p = find_if(banned_ip_temporary.begin(), banned_ip_temporary.end(), 
        [&](const pair<string, long long int>& element) { return element.first == clientConnection; });
    
    if (p != banned_ip_temporary.end()) {
        if (banned_ip_temporary[p - banned_ip_temporary.begin()].second + CONNECT_TIME > 
            (duration_cast<milliseconds>(system_clock::now().time_since_epoch())).count()) {
            enet_peer_disconnect_later(peer, 0);
            quit = true;
        }
    }
    
    if (quit) break;
    
    // Login rate limiting
    string error = "";
    int logged = 0;
    if (login_time + 6500 < (duration_cast<milliseconds>(system_clock::now().time_since_epoch())).count()) {
        login_count = 0;
        login_time = (duration_cast<milliseconds>(system_clock::now().time_since_epoch())).count();
    }
    
    if (login_count < 8) {
        for (ENetPeer* currentPeer = server->peers; currentPeer < &server->peers[server->peerCount]; ++currentPeer) {
            if (currentPeer->state != ENET_PEER_STATE_CONNECTED || currentPeer->data == NULL || 
                pInfo(peer)->ip != pInfo(currentPeer)->ip) 
                continue;
            logged++;
        }
    }
    
    // Kirim packet tambahan untuk memaksa download
    if (!quit) {
        std::this_thread::sleep_for(std::chrono::milliseconds(200));
        
        // Packet untuk world data (type 3)
        send_gt_packet(peer, 3);
        
        // Packet untuk item definitions (type 4)
        send_gt_packet(peer, 4);
        
        printf("[CONNECT] New player connected: ID=%u, IP=%s\n", peer->connectID, clientConnection);
    }
    
    break;
}
